---
title: Mapping NEON Survey Monitoring Data to the Humboldt
  Extension for Ecological Inventories
author: "Chandra Earl"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    anchor_sections: yes
subtitle: "[Guide for publishing biological survey and monitoring data to GBIF](https://docs.gbif.org/guide-publishing-survey-data/en/)"
---
<style>
  #TOC {
    margin-top: 10px !important;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  var toc = document.querySelector(".tocify");
  if (toc) {
    var logoDiv = document.createElement("div");
    logoDiv.style.textAlign = "left";
    logoDiv.style.marginTop = "10px";
    logoDiv.innerHTML = `
      <a href="https://www.gbif.org/" target="_blank">
        <img src="https://docs.gbif.org/style/logo.svg" 
             alt="GBIF Logo" 
             style="width:180px; height:auto; margin-left:17px;">
      </a>
      <hr style="border: none; border-top: 1px solid #ccc; margin: 10px 0;">
      <a href="https://github.com/sunray1/NEONTickstoHumboldt" target="_blank" style="text-decoration:none; color:inherit; margin-left:14px;">
        <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" 
             alt="GitHub repository" style="width:28px; height:auto; vertical-align:middle;">
        <span style="font-size: 13px; margin-left: 6px;">View on GitHub</span>
      </a>
      <hr style="border: none; border-top: 1px solid #ccc; margin: 10px 0;">
    `;
    toc.insertBefore(logoDiv, toc.firstChild);
  }
});
</script>

# Introduction

This example has been created alongside the [GBIF Guide for publishing biological survey and monitoring data to GBIF](https://docs.gbif.org/guide-publishing-survey-data/en/) to illustrate how data from the [National Ecological Observatory Network (NEON)](https://www.neonscience.org/) can be expressed using Darwin Core and the [Humboldt Extension for Ecological Inventories](https://eco.tdwg.org/). The workflow produces the four core Darwin Core tables used for publishing survey datasets to GBIF: Event, Occurrence, ResourceRelationship, and ExtendedMeasurementOrFact.  
The dataset is structured hierarchically, with events defined at multiple levels (project, domain, site, plot, and plot visit). Occurrences represent collected ticks as well as subsequent laboratory results derived from them. Contextual information on sampling design, effort, and scope is expressed through Humboldt Extension terms.

## Introduction to NEON Tick Data

The U.S. National Science Foundation’s National Ecological Observatory Network (NEON) carries out long-term, standardized monitoring of tick populations and tick-borne pathogens across the United States. Sampling is conducted only at terrestrial sites, where field staff survey designated plots every three to six weeks during the active tick season. Surveys are performed by dragging or flagging along the 160 m perimeter of each 40 × 40 m plot, and ticks of all life stages are collected and preserved in ethanol.

</br>
<div style="display: flex; justify-content: center; gap: 1em;">
  <figure style="text-align: center;">
    <img src="https://live.staticflickr.com/65535/50754759486_94f857bf43_c.jpg" width="100%">
    <figcaption>Ecologist dragging for ticks</figcaption>
  </figure>
  <figure style="text-align: center;">
    <img src="https://live.staticflickr.com/65535/48790746127_00c1d1ccfb_c.jpg" width="75%">
    <figcaption>Collected ticks in ethanol</figcaption>
  </figure>
</div>
</br>

In the laboratory, specimens are identified to species, life stage, and sex when possible. A subset of nymphal ticks is further tested for common pathogens of public health and veterinary concern, including *Borrelia burgdorferi* (Lyme disease), *Anaplasma phagocytophilum* (anaplasmosis), *Babesia microti* (babesiosis), *Ehrlichia* spp., and several *Rickettsia* species. Only morphologically identified nymphs are selected for pathogen testing.  

More details on NEON’s tick monitoring program are available from the [NEON tick data resource page](https://www.neonscience.org/data-collection/ticks). Protocols referenced in the data can be found in the [Document Library](https://data.neonscience.org/documents).

## Introduction to NEON's Hierarchical Dataset Structure

![](https://docs.gbif.org/guide-publishing-survey-data/img/Fig5.png){width=100%}

NEON biological datasets are organized as deeply nested structures that reflect the standardized design of the survey program [Thorpe et al. 2016](https://doi.org/10.1002/ecs2.1627). At the highest level is the project, which defines the scope of the observatory-wide program. Beneath this, the locality component is divided into three spatial scales:

1. 20 ecoclimatic domains,
2. 81 individual sites (47 terrestrial and 34 aquatic) within those domains, and
3. Spatial sampling units within each site—such as plots, segments, or reaches—defined according to site type and the requirements of specific protocols.

Locality information at the domain, site, and sampling unit levels is captured at the upper Event levels of the hierarchy. Information specific to individual visits is reported at the lowest Event level. Sampling context is described using the [Darwin Core Event Core](https://dwc.tdwg.org/terms/#event) and [Humboldt Extension](https://rs.gbif.org/extension/eco/Humboldt_2024-04-16.xml), while additional measurements are recorded using the [Extended Measurement or Fact (eMoF) Extension](https://rs.gbif.org/extension/obis/extended_measurement_or_fact_2023-08-28.xml). Depending on the data collected, additional extensions can be incorporated, such as [Multimedia](https://rs.gbif.org/extension/ac/audubon_2020_10_06.xml) or [DNA-derived data](https://rs.gbif.org/extension/gbif/1.0/dna_derived_data_2024-04-17.xml).  

[Occurrence records](https://rs.gbif.org/core/dwc_occurrence_2024-02-23.xml) are linked to the appropriate Event levels to capture what organisms were observed or collected during each visit. In this example, tick specimens collected in the field are represented as preserved specimen occurrences, while pathogen testing results are represented as separate occurrence records. To maintain associations with the original tick specimens, these records are linked back to the host occurrences using the [Resource Relationship Extension](https://rs.gbif.org/extension/resource_relationship_2024-02-19.xml).

See also [Box 1](https://docs.gbif.org/guide-publishing-survey-data/en/#box-1-national-science-foundations-national-ecological-observatory-network-neon-example) of the Guide.

# Load libraries

The code examples in this document use R functions provided by the `neonUtilities` package together with `dplyr` for data manipulation. These libraries allow automated download and processing of NEON data products to prepare them for mapping to Darwin Core and the Humboldt Extension.

```{r message=FALSE, warning=FALSE}
library(neonUtilities)
library(dplyr)
```

# Download Data

The data used in this example come from two NEON data products: tick pathogen status and ticks sampled using drag cloths. This workflow uses data from **[RELEASE-2025](https://data.neonscience.org/data-releases/RELEASE-2025)**.  

- [NEON 2025a] NEON (National Ecological Observatory Network) [1]. 2025. NEON Tick pathogen status (DP1.10092.001), RELEASE-2025. https://doi.org/10.48443/8nhe-cp13. Dataset accessed from [NEON Data Portal](https://data.neonscience.org/data-products/DP1.10092.001/RELEASE-2025) on 2025-09-25.  
- [NEON 2025b] NEON (National Ecological Observatory Network) [2]. 2025. NEON Ticks sampled using drag cloths (DP1.10093.001), RELEASE-2025. https://doi.org/10.48443/6zpz-5z19. Dataset accessed from [NEON Data Portal](https://data.neonscience.org/data-products/DP1.10093.001/RELEASE-2025) on 2025-09-25.  

A NEON token was used to download the original data for this workflow. Tokens are optional but recommended, as they allow authenticated access and help avoid API rate limits when downloading large datasets. Users preparing their own mappings may wish to generate a personal token. For more information, see the [Using an API Token when Accessing NEON Data with neonUtilities tutorial](https://www.neonscience.org/resources/learning-hub/tutorials/neon-api-tokens-tutorial) and the [NEON API token documentation](https://data.neonscience.org/data-api/rate-limiting/#api-tokens).

## Get Tick and Tick Pathogen data

```{r}
if (!dir.exists("data")) {
  dir.create("data")
}

if (!dir.exists("outputs")) {
  dir.create("outputs")
}

if (file.exists("data/tick.pathogen.RData")) {
  load("data/tick.pathogen.RData")
} else {
  
  tick.pathogen <- loadByProduct(dpID="DP1.10092.001", 
                                 package = "basic",
                                 release = "RELEASE-2025",
                                 token = Sys.getenv("NEON_TOKEN"),
                                 check.size = F)
  
  save(tick.pathogen, file = "data/tick.pathogen.RData")
}

if (file.exists("data/tick.occurrence.RData")) {
  load("data/tick.occurrence.RData")
} else {
  
  tick.occurrence <- loadByProduct(dpID="DP1.10093.001", 
                                   package = "basic",
                                   release = "RELEASE-2025",
                                   token = Sys.getenv("NEON_TOKEN"),
                                   check.size = F)
  
  save(tick.occurrence, file = "data/tick.occurrence.RData")
}

```

# Map Data

## Map Event Data

The event hierarchy presented here follows the structure of NEON’s sampling design, with events defined at project, domain, site, sampling unit (plot), and individual sampling event (plot visit) levels. Some event-level information is not provided directly in the NEON data download, such as details describing the overall project, individual domains, and sites. To capture the full hierarchy of the sampling design, these additional levels are reconstructed and included in the event table. The values are hard-coded based on latest (2025-09-24) NEON information.  

Domain-level metadata was compiled from NEON documentation and geospatial files. A polygon shapefile defining NEON’s domain boundaries was downloaded from [NEONDomains_2024.zip](https://www.neonscience.org/sites/default/files/NEONDomains_2024.zip) (last updated October 2024, CRS: Geographic WGS 84). Domain centroids (latitude and longitude) and associated uncertainty values were calculated from this shapefile using ArcGIS.  

Site-level metadata was retrieved directly from NEON’s public API on September 24, 2025 using the field site metadata download (*NEON_Field_Site_Metadata_20250924*). This download represents a flattened subset of the full JSON objects returned by the [locations/sites API endpoint](https://data.neonscience.org/api/v0/locations/sites).

All fields from the [survey event table template](https://github.com/gbif/doc-guide-publishing-survey-data/tree/1.1_postCommReview/data/event_template_wHE_event-table.csv) are retained for completeness, even when particular values are not applicable for this dataset.  

### Project Event

The project event describes the overall tick monitoring program within NEON. It defines the scope of the survey (taxonomic, geographic, temporal), the general sampling protocols, and whether absence, abundance, and material samples are reported.

```{r}
NEON_project_event <- data.frame(parentEventID = NA, #Q: should I add namespace to these terms?
                                  eventID = "NEON",
                                  siteNestingDescription = "46 terrestrial sites each with at least six 40×40 m plots designated for tick sampling (plots may be decommissioned and reassigned as necessary, but six plots are required for sampling) located across 19 ecoclimatic domains",
                                  siteCount = length(unique(tick.occurrence$tck_fielddata$plotID)),
                                  fieldNumber = NA,
                                  verbatimSiteNames = paste(sort(unique(tick.occurrence$tck_fielddata$plotID)), collapse = " | "),
                                  habitat = NA,
                                  verbatimSiteDescriptions = NA,
                                  reportedWeather = NA,
                                  reportedExtremeConditions = NA,
                                  locationID = NA,
                                  countryCode = "US",
                                  decimalLatitude = NA,
                                  decimalLongitude = NA,
                                  coordinateUncertaintyInMeters = NA,
                                  geodeticDatum = NA,
                                  locality = NA,
                                  totalAreaSampledValue = length(unique(tick.occurrence$tck_fielddata$plotID)) * 40 * 4, #summed value of plot perimeters
                                  totalAreaSampledUnit = "m",
                                  geospatialScopeAreaValue = 9428288, #full geographic extent of USA-NEON boundaries
                                  geospatialScopeAreaUnit = "km²",
                                  sampleSizeValue = NA,
                                  sampleSizeUnit = NA,
                                  footprintWKT = NA,
                                  footprintSRS = NA,
                                  isVegetationCoverReported = "false",
                                  eventDate = paste(
                                    min(tick.occurrence$tck_fielddata$collectDate, na.rm = TRUE),
                                    max(tick.occurrence$tck_fielddata$collectDate, na.rm = TRUE),
                                    sep = "/"
                                  ),
                                  eventTime = NA,
                                  eventDurationValue = NA,
                                  eventDurationUnit = NA,
                                  eventType = "project",
                                  inventoryTypes = NA, #Q: I guess we could consider this an inventory and fill out this and the following, though the guide says only if eventType = Inventory
                                  compilationTypes = NA,
                                  compilationSourceTypes = NA,
                                  samplingProtocol = "Drag sampling | Flagging",
                                  protocolNames = "Drag sampling | Flagging",
                                  protocolDescriptions = "Ticks are sampled at six plots per site every three to six weeks, depending on prior detections. Sampling follows the 160 m perimeter of each 40 × 40 m plot, using drag cloths (or flagging in dense vegetation). Ticks from all life stages are collected every few meters and preserved in ethanol, with bouts scheduled between green-up and dormancy. Samples are sent to external labs where they are sorted, counted and a subset of identified nymphs are tested for pathogens.",
                                  protocolReferences = "Paull, S. 2022. TOS Protocol and Procedure: TCK – Tick and Tick-Borne Pathogen Sampling. NEON.DOC.014045. NEON (National Ecological Observatory Network). | Laboratory of Medical Zoology (LMZ). 2023. NEON Tick Pathogen Testing SOP, V4.01. University of Massachusetts, Amherst. | Beati, L. 2021. Tick Identification Instructions, USNTC Standard Operating Procedure (SOP). V3. Georgia Southern University, US National Tick Collection (USNTC).",
                                  isAbsenceReported = "true", #Q: Should this be reported true at this level or only at the event visit level?
                                  absentTaxa = NA,
                                  isAbundanceReported = "true",
                                  isAbundanceCapReported = "false",
                                  abundanceCap = NA,
                                  hasMaterialSamples = "true", #Q: Since we're not explicitly designating these as material samples, should this be false?
                                  materialSampleTypes = "wholeOrganism",
                                  hasVouchers = "true",
                                  voucherInstitutions = "US National Tick Collection, Georgia Southern University",
                                  isLeastSpecificTargetCategoryQuantityInclusive = "false",
                                  dataGeneralizations = NA,
                                  informationWithheld = NA, #TODO: double check this - I don't think any tick taxa are withheld but I'm not 100% certain
                                  fieldNotes = NA,
                                  eventRemarks = NA,
                                  verbatimTargetScope = "ticks",
                                  targetTaxonomicScope = "?Ixodidae", #Q: Since we have pathogens in occurrences, I'm not sure how to designate those here - the ones tested don't have a mca - most are Bacteria but one is a piroplasm
                                  excludedTaxonomicScope = NA,
                                  isTaxonomicScopeFullyReported = "true",
                                  taxonCompletenessReported = "reportedComplete", #Q: I'm not 100% sure I did these two correctly
                                  taxonCompletenessProtocols = "Tick drag/flag methods are standardized to comprehensively detect all life stages of Ixodidae during the active season.", #Q: I'm not 100% sure I did these two correctly
                                  hasNonTargetTaxa = "false",
                                  areNonTargetTaxaFullyReported = NA,
                                  nonTargetTaxa = NA,
                                  identifiedBy = paste(unique(tick.occurrence$tck_taxonomyProcessed$laboratoryName), collapse = " | "), #Q: I could change this to paste(unique(tick.occurrence$tck_taxonomyProcessed$identifiedBy), collapse = " | ") and get the actual list of people who did the identifications, though this is not clean
                                  targetLifeStageScope = "adult | nymph | larvae",
                                  excludedLifeStageScope = "egg",
                                  isLifeStageScopeFullyReported = "true",
                                  targetDegreeOfEstablishmentScope = NA,
                                  excludedDegreeOfEstablishmentScope = NA,
                                  isDegreeOfEstablishmentScopeFullyReported = NA,
                                  targetGrowthFormScope = NA,
                                  excludedGrowthFormScope = NA,
                                  isGrowthFormScopeFullyReported = NA,
                                  hasNonTargetOrganisms = NA,
                                  targetHabitatScope = NA,
                                  excludedHabitatScope = NA,
                                  samplingEffort = "6 plots per bout, 160 m perimeter sampled per plot",
                                  isSamplingEffortReported = "true",
                                  samplingEffortProtocol = "Ticks are sampled at six plots per site, with bouts every 3 or 6 weeks depending on intensity. Each bout consists of dragging (or flagging if needed) along the full 160 m perimeter of each 40 × 40 m plot. Ticks of all life stages are collected at intervals and preserved in ethanol.",
                                  samplingEffortValue = "6, 160",
                                  samplingEffortUnit = "plots per bout, meters per plot circuit",
                                  samplingPerformedBy = "NEON Field Staff" #Q: I could change this to paste(unique(tick.occurrence$tck_fielddata$measuredBy), collapse = " | ") and get the list of actual people, though this has orcid and emails and is quite messy
                                )
```

### Domain Events

Domains represent NEON’s ecoclimatic regions. Each domain includes one or more terrestrial sites where tick sampling occurs. Tick data are available for 19 of the 20 NEON domains, as no tick sampling is conducted in Domain 20 (Hawai‘i).

```{r}
NEON_domain_metadata <- read.csv("data/NEON_Domain_Metadata_20250924.csv", stringsAsFactors = FALSE)

NEON_domain_list <- unique(tick.occurrence$tck_fielddata[, c("domainID")])

#index
domain_idx <- match(NEON_domain_list, NEON_domain_metadata$domain_id)

added_domain_data <- data.frame(parentEventID = "NEON",
                                eventID = NEON_domain_metadata$domain_id[domain_idx],
                                siteNestingDescription = "Each domain contains 1-3 terrestrial field sites, each with at least six 40×40 m plots designated for tick sampling (plots may be decommissioned and reassigned as necessary, but six plots are required for sampling)",
                                siteCount = tapply(tick.occurrence$tck_fielddata$plotID,    #Get number of sampled plots per domain
                                                   tick.occurrence$tck_fielddata$domainID,
                                                   function(x) length(unique(x)))[NEON_domain_list],
                                fieldNumber = NA,
                                verbatimSiteNames = tapply(tick.occurrence$tck_fielddata$plotID,     #Get list of sampled plots at each domain
                                                           tick.occurrence$tck_fielddata$domainID,
                                                           function(x) paste(sort(unique(x)), collapse = " | ")
                                                         )[NEON_domain_list],
                                habitat = NA,
                                verbatimSiteDescriptions = NA,
                                reportedWeather = NA,
                                reportedExtremeConditions = NA,
                                locationID = NEON_domain_metadata$domain_id[domain_idx],
                                countryCode = "US",
                                decimalLatitude = NEON_domain_metadata$decimalLatitude[domain_idx],
                                decimalLongitude = NEON_domain_metadata$decimalLongitude[domain_idx],
                                coordinateUncertaintyInMeters = NEON_domain_metadata$coordinateUncertaintyinMeters[domain_idx],
                                geodeticDatum = "WGS84",
                                locality = paste(NEON_domain_metadata$domain_name[domain_idx], " (", NEON_domain_metadata$domain_id[domain_idx], ")", sep = ""),
                                totalAreaSampledValue = tapply(tick.occurrence$tck_fielddata$plotID, #summed value of surveyed plot perimeters in domain
                                                               tick.occurrence$tck_fielddata$domainID,
                                                               function(x) length(unique(x)))[NEON_domain_list] * 40 * 4,
                                totalAreaSampledUnit = "m",
                                geospatialScopeAreaValue = NEON_domain_metadata$sq_km[domain_idx],
                                geospatialScopeAreaUnit = "km²",
                                sampleSizeValue = NA,
                                sampleSizeUnit = NA,
                                footprintWKT = NA, #Q: I'm not going to bother with these since they'll be huge
                                footprintSRS = NA,
                                isVegetationCoverReported = "false",
                                eventDate = tapply(
                                  tick.occurrence$tck_fielddata$collectDate,
                                  tick.occurrence$tck_fielddata$domainID,
                                  function(x) paste(min(x, na.rm = TRUE), max(x, na.rm = TRUE), sep = "/")
                                )[NEON_domain_list],
                                eventTime = NA,
                                eventDurationValue = NA,
                                eventDurationUnit = NA,
                                eventType = "domain",
                                inventoryTypes = NA,
                                compilationTypes = NA,
                                compilationSourceTypes = NA,
                                samplingProtocol = "Drag sampling | Flagging", #Sampling protocol terms should be populated for every Event regardless of hierarchical level Q: I took this to mean all the terms described in 5.5. Methodology or sampling protocol (from here up to eventRemarks), or is this just for the four protocol fields?
                                protocolNames = "Drag sampling | Flagging",
                                protocolDescriptions = "Ticks are sampled at six plots per site every three to six weeks, depending on prior detections. Sampling follows the 160 m perimeter of each 40 × 40 m plot, using drag cloths (or flagging in dense vegetation). Ticks from all life stages are collected every few meters and preserved in ethanol, with bouts scheduled between green-up and dormancy. Samples are sent to external labs where they are sorted, counted and a subset of identified nymphs are tested for pathogens.",
                                protocolReferences = "Paull, S. 2022. TOS Protocol and Procedure: TCK – Tick and Tick-Borne Pathogen Sampling. NEON.DOC.014045. NEON (National Ecological Observatory Network). | Laboratory of Medical Zoology (LMZ). 2023. NEON Tick Pathogen Testing SOP, V4.01. University of Massachusetts, Amherst. | Beati, L. 2021. Tick Identification Instructions, USNTC Standard Operating Procedure (SOP). V3. Georgia Southern University, US National Tick Collection (USNTC).",
                                isAbsenceReported = "true", #Q: Should this be reported true at this level or only at the event visit level?
                                absentTaxa = NA,
                                isAbundanceReported = "true",
                                isAbundanceCapReported = "false",
                                abundanceCap = NA,
                                hasMaterialSamples = "true", #Q: Since we're not explicitly designating these as material samples, should this be false?
                                materialSampleTypes = "wholeOrganism",
                                hasVouchers = "true",
                                voucherInstitutions = "US National Tick Collection, Georgia Southern University",
                                isLeastSpecificTargetCategoryQuantityInclusive = "false",
                                dataGeneralizations = NA,
                                informationWithheld = NA, #TODO: double check this - I don't think any tick taxa are withheld but I'm not 100% certain
                                fieldNotes = NA,
                                eventRemarks = NA,
                                verbatimTargetScope = "ticks", # Recommended best practice is to populate scope terms every Event to which they apply.
                                targetTaxonomicScope = "?Ixodidae", #Q: Since we have pathogens in occurrences, I'm not sure how to designate those here - the ones tested don't have a mca - most are Bacteria but one is a piroplasm
                                excludedTaxonomicScope = NA,
                                isTaxonomicScopeFullyReported = "true",
                                taxonCompletenessReported = "reportedComplete", #Q: I'm not 100% sure I did these two correctly
                                taxonCompletenessProtocols = "Tick drag/flag methods are standardized to comprehensively detect all life stages of Ixodidae during the active season.", #Q: I'm not 100% sure I did these two correctly
                                hasNonTargetTaxa = "false",
                                areNonTargetTaxaFullyReported = NA,
                                nonTargetTaxa = NA,
                                identifiedBy = tick.occurrence$tck_taxonomyProcessed %>% 
                                  left_join(tick.occurrence$tck_fielddata %>% select(sampleID, domainID),
                                            by = "sampleID") %>%
                                  group_by(domainID) %>%
                                  summarise(identifiedBy = paste(sort(unique(laboratoryName)), collapse = " | "),
                                            .groups = "drop") %>%
                                  right_join(data.frame(domainID = NEON_domain_list), by = "domainID") %>%
                                  arrange(match(domainID, NEON_domain_list)) %>%
                                  mutate(identifiedBy = ifelse(is.na(identifiedBy), NA, identifiedBy)) %>% #Q: Some domains/sites have had no ticks found, so identifiedBy is NA - should this be changed to something more descriptive, like 'No ticks found'?
                                  pull(identifiedBy), #Q: I could change this to get the actual list of people who did the identifications, though this is not clean
                                targetLifeStageScope = "adult | nymph | larvae",
                                excludedLifeStageScope = "egg",
                                isLifeStageScopeFullyReported = "true",
                                targetDegreeOfEstablishmentScope = NA,
                                excludedDegreeOfEstablishmentScope = NA,
                                isDegreeOfEstablishmentScopeFullyReported = NA,
                                targetGrowthFormScope = NA,
                                excludedGrowthFormScope = NA,
                                isGrowthFormScopeFullyReported = NA,
                                hasNonTargetOrganisms = NA,
                                targetHabitatScope = NA,
                                excludedHabitatScope = NA,
                                samplingEffort = "6 plots per bout, 160 m perimeter sampled per plot",
                                isSamplingEffortReported = "true",
                                samplingEffortProtocol = "Ticks are sampled at six plots per site, with bouts every 3 or 6 weeks depending on intensity. Each bout consists of dragging (or flagging if needed) along the full 160 m perimeter of each 40 × 40 m plot. Ticks of all life stages are collected at intervals and preserved in ethanol.",
                                samplingEffortValue = "6, 160",
                                samplingEffortUnit = "plots per bout, meters per plot circuit",
                                samplingPerformedBy = "NEON Field Staff" #Q: I could change this to paste(unique(tick.occurrence$tck_fielddata$measuredBy), collapse = " | ") and get the list of actual people, though this has orcid and emails and is quite messy
                              )
```


### Site Events

Each NEON terrestrial site contains at least six 40×40 m plots designated for tick sampling. Tick sampling is conducted only at terrestrial sites (47 in total), but because no sampling is performed at PUUM in Hawai‘i (Domain 20), only 46 sites are included here. Site events record location metadata, habitat information, and elevation.

```{r}
NEON_site_metadata <- read.csv(
  "https://www.neonscience.org/field-sites/exports/NEON_Field_Site_Metadata_20250924",
  stringsAsFactors = FALSE
)

NEON_site_list <- unique(tick.occurrence$tck_fielddata[, c("siteID")])

#indexes
site_idx <- match(NEON_site_list, NEON_site_metadata$site_id)

added_site_data <- data.frame(parentEventID = NEON_site_metadata$domain_id[site_idx],
                              eventID = NEON_site_metadata$site_id[site_idx],
                              siteNestingDescription = "Each site contains at least six 40×40 m plots designated for tick sampling (plots may be decommissioned and reassigned as necessary, but six plots are required for sampling)",
                              siteCount = tapply(tick.occurrence$tck_fielddata$plotID,    #Get number of sampled plots per site
                                                 tick.occurrence$tck_fielddata$siteID,
                                                 function(x) length(unique(x)))[NEON_site_list],
                              fieldNumber = NA,
                              verbatimSiteNames = tapply(tick.occurrence$tck_fielddata$plotID,     #Get list of sampled plots at each site
                                                         tick.occurrence$tck_fielddata$siteID,
                                                         function(x) paste(sort(unique(x)), collapse = " | ")
                                                       )[NEON_site_list],
                              habitat = gsub("\\|", " | ", NEON_site_metadata$dominant_nlcd_classes[site_idx]),
                              verbatimSiteDescriptions = NEON_site_metadata$site_type[site_idx],
                              reportedWeather = NA,
                              reportedExtremeConditions = NA,
                              locationID = NEON_site_metadata$site_id[site_idx],
                              countryCode = "US",
                              county = NEON_site_metadata$site_county[site_idx],
                              stateProvince = NEON_site_metadata$site_state[site_idx],
                              decimalLatitude = NEON_site_metadata$latitude[site_idx],
                              decimalLongitude = NEON_site_metadata$longitude[site_idx],
                              coordinateUncertaintyInMeters = NA, #Q: I can attempt to get uncertainty for each site but we don't have it handy and I'd have to calculate it by hand
                              geodeticDatum = "WGS84",
                              locality = paste(NEON_site_metadata$site_name[site_idx], " (", NEON_site_metadata$site_id[site_idx], ")", sep = ""),
                              minimumElevationInMeters = NEON_site_metadata$minimum_elevation_m[site_idx],
                              maximumElevationInMeters = NEON_site_metadata$maximum_elevation_m[site_idx],
                              verbatimElevation = paste(NEON_site_metadata$mean_evelation_m[site_idx], "m", sep=""),
                              totalAreaSampledValue = tapply(tick.occurrence$tck_fielddata$plotID, #summed value of surveyed plot perimeters in site
                                                             tick.occurrence$tck_fielddata$siteID,
                                                             function(x) length(unique(x)))[NEON_site_list] * 40 * 4,
                              totalAreaSampledUnit = "m",
                              geospatialScopeAreaValue = NEON_site_metadata$terrestrial_sampling_boundary_size_km2[site_idx],
                              geospatialScopeAreaUnit = "km²",
                              sampleSizeValue = NA,
                              sampleSizeUnit = NA,
                              footprintWKT = NA, #Q: I'm not going to bother with these since they'll be huge
                              footprintSRS = NA,
                              isVegetationCoverReported = "false",
                              eventDate = tapply(
                                tick.occurrence$tck_fielddata$collectDate,
                                tick.occurrence$tck_fielddata$siteID,
                                function(x) paste(min(x, na.rm = TRUE), max(x, na.rm = TRUE), sep = "/")
                              )[NEON_site_list],
                              eventTime = NA,
                              eventDurationValue = NA,
                              eventDurationUnit = NA,
                              eventType = "site", 
                              inventoryTypes = NA,
                              compilationTypes = NA,
                              compilationSourceTypes = NA,
                              samplingProtocol = "Drag sampling | Flagging", #Sampling protocol terms should be populated for every Event regardless of hierarchical level Q: I took this to mean all the terms described in 5.5. Methodology or sampling protocol (from here up to eventRemarks), or is this just for the four protocol fields?
                              protocolNames = "Drag sampling | Flagging",
                              protocolDescriptions = "Ticks are sampled at six plots per site every three to six weeks, depending on prior detections. Sampling follows the 160 m perimeter of each 40 × 40 m plot, using drag cloths (or flagging in dense vegetation). Ticks from all life stages are collected every few meters and preserved in ethanol, with bouts scheduled between green-up and dormancy. Samples are sent to external labs where they are sorted, counted and a subset of identified nymphs are tested for pathogens.",
                              protocolReferences = "Paull, S. 2022. TOS Protocol and Procedure: TCK – Tick and Tick-Borne Pathogen Sampling. NEON.DOC.014045. NEON (National Ecological Observatory Network). | Laboratory of Medical Zoology (LMZ). 2023. NEON Tick Pathogen Testing SOP, V4.01. University of Massachusetts, Amherst. | Beati, L. 2021. Tick Identification Instructions, USNTC Standard Operating Procedure (SOP). V3. Georgia Southern University, US National Tick Collection (USNTC).",
                              isAbsenceReported = "true", #Q: Should this be reported true at this level or only at the event visit level?
                              absentTaxa = NA,
                              isAbundanceReported = "true",
                              isAbundanceCapReported = "false",
                              abundanceCap = NA,
                              hasMaterialSamples = "true", #Q: Since we're not explicitly designating these as material samples, should this be false?
                              materialSampleTypes = "wholeOrganism",
                              hasVouchers = "true",
                              voucherInstitutions = "US National Tick Collection, Georgia Southern University",
                              isLeastSpecificTargetCategoryQuantityInclusive = "false",
                              dataGeneralizations = NA,
                              informationWithheld = NA, #TODO: double check this - I don't think any tick taxa are withheld but I'm not 100% certain
                              fieldNotes = NA,
                              eventRemarks = NA,
                              verbatimTargetScope = "ticks", # Recommended best practice is to populate scope terms every Event to which they apply.
                              targetTaxonomicScope = "?Ixodidae", #Q: Since we have pathogens in occurrences, I'm not sure how to designate those here - the ones tested don't have a mca - most are Bacteria but one is a piroplasm
                              excludedTaxonomicScope = NA,
                              isTaxonomicScopeFullyReported = "true",
                              taxonCompletenessReported = "reportedComplete", #Q: I'm not 100% sure I did these two correctly
                              taxonCompletenessProtocols = "Tick drag/flag methods are standardized to comprehensively detect all life stages of Ixodidae during the active season.", #Q: I'm not 100% sure I did these two correctly
                              hasNonTargetTaxa = "false",
                              areNonTargetTaxaFullyReported = NA,
                              nonTargetTaxa = NA,
                              identifiedBy = tick.occurrence$tck_taxonomyProcessed %>% 
                                left_join(tick.occurrence$tck_fielddata %>% select(sampleID, siteID),
                                          by = "sampleID") %>%
                                group_by(siteID) %>%
                                summarise(identifiedBy = paste(sort(unique(laboratoryName)), collapse = " | "),
                                          .groups = "drop") %>%
                                right_join(data.frame(siteID = NEON_site_list), by = "siteID") %>%
                                arrange(match(siteID, NEON_site_list)) %>%
                                mutate(identifiedBy = ifelse(is.na(identifiedBy), NA, identifiedBy)) %>% #Q: Some domains/sites have had no ticks found, so identifiedBy is NA - should this be changed to something more descriptive, like 'No ticks found'?
                                pull(identifiedBy), #Q: I could change this to get the actual list of people who did the identifications, though this is not clean
                              targetLifeStageScope = "adult | nymph | larvae",
                              excludedLifeStageScope = "egg",
                              isLifeStageScopeFullyReported = "true",
                              targetDegreeOfEstablishmentScope = NA,
                              excludedDegreeOfEstablishmentScope = NA,
                              isDegreeOfEstablishmentScopeFullyReported = NA,
                              targetGrowthFormScope = NA,
                              excludedGrowthFormScope = NA,
                              isGrowthFormScopeFullyReported = NA,
                              hasNonTargetOrganisms = NA,
                              targetHabitatScope = NA,
                              excludedHabitatScope = NA,
                              samplingEffort = "6 plots per bout, 160 m perimeter sampled per plot",
                              isSamplingEffortReported = "true",
                              samplingEffortProtocol = "Ticks are sampled at six plots per site, with bouts every 3 or 6 weeks depending on intensity. Each bout consists of dragging (or flagging if needed) along the full 160 m perimeter of each 40 × 40 m plot. Ticks of all life stages are collected at intervals and preserved in ethanol.",
                              samplingEffortValue = "6, 160",
                              samplingEffortUnit = "plots per bout, meters per plot circuit",
                              samplingPerformedBy = "NEON Field Staff" #Q: I could change this to paste(unique(tick.occurrence$tck_fielddata$measuredBy), collapse = " | ") and get the list of actual people, though this has orcid and emails and is quite messy
                            )

```

### Plot Events

Plot events represent the smallest fixed spatial unit within NEON’s tick monitoring design. Each plot is a 40×40 m area where drag or flag sampling is carried out. Plot-level metadata include plot identifiers, habitat classification, and elevation.

```{r}
NEON_plot_metadata <- unique(tick.occurrence$tck_fielddata[, c("namedLocation",
                                                               "siteID",
                                                               "plotID",
                                                               "plotType",
                                                               "nlcdClass",
                                                               "decimalLatitude",
                                                               "decimalLongitude",
                                                               "geodeticDatum",
                                                               "coordinateUncertainty",
                                                               "elevation",
                                                               "elevationUncertainty")])

NEON_plot_metadata <- NEON_plot_metadata %>% #There's an issue where plot JERC_081 has two elevations, causing it to be duplicated, so we'll just remove the first one
  distinct(namedLocation, plotID, .keep_all = TRUE)

added_plot_data <- data.frame(parentEventID = NEON_plot_metadata$siteID,
                              eventID = NEON_plot_metadata$plotID,
                              siteNestingDescription = "One 40×40 m plot designated for tick sampling",
                              siteCount = 1,
                              fieldNumber = NA,
                              verbatimSiteNames = NEON_plot_metadata$plotID,
                              habitat = NEON_plot_metadata$nlcdClass,
                              verbatimSiteDescriptions = NA,
                              reportedWeather = NA,
                              reportedExtremeConditions = NA,
                              locationID = NEON_plot_metadata$plotID,
                              countryCode = "US",
                              decimalLatitude = NEON_plot_metadata$decimalLatitude,
                              decimalLongitude = NEON_plot_metadata$decimalLongitude,
                              coordinateUncertaintyInMeters = NEON_plot_metadata$coordinateUncertainty,
                              geodeticDatum = "WGS84",
                              locality = NEON_plot_metadata$plotID,
                              minimumElevationinMeters = NEON_plot_metadata$elevation - NEON_plot_metadata$elevationUncertainty,
                              maximumElevationinMeters = NEON_plot_metadata$elevation + NEON_plot_metadata$elevationUncertainty,
                              verbatimElevation = paste(NEON_plot_metadata$elevation, "m", sep=""),
                              totalAreaSampledValue = 40 * 4,
                              totalAreaSampledUnit = "m",
                              geospatialScopeAreaValue = 40 * 4,
                              geospatialScopeAreaUnit = "m",
                              sampleSizeValue = NA,
                              sampleSizeUnit = NA,
                              footprintWKT = NA,
                              footprintSRS = NA,
                              isVegetationCoverReported = "false",
                              eventDate = tapply(
                                tick.occurrence$tck_fielddata$collectDate,
                                tick.occurrence$tck_fielddata$plotID,
                                function(x) paste(min(x, na.rm = TRUE), max(x, na.rm = TRUE), sep = "/")
                              )[NEON_plot_metadata$plotID],
                              eventTime = NA,
                              eventDurationValue = NA,
                              eventDurationUnit = NA,
                              eventType = "plot", #Q: This was 'Survey' in the mapping sheet
                              inventoryTypes = NA,
                              compilationTypes = NA,
                              compilationSourceTypes = NA,
                              samplingProtocol = "Drag sampling | Flagging", #Sampling protocol terms should be populated for every Event regardless of hierarchical level Q: I took this to mean all the terms described in 5.5. Methodology or sampling protocol (from here up to eventRemarks), or is this just for the four protocol fields?
                              protocolNames = "Drag sampling | Flagging",
                              protocolDescriptions = "Ticks are sampled at six plots per site every three to six weeks, depending on prior detections. Sampling follows the 160 m perimeter of each 40 × 40 m plot, using drag cloths (or flagging in dense vegetation). Ticks from all life stages are collected every few meters and preserved in ethanol, with bouts scheduled between green-up and dormancy. Samples are sent to external labs where they are sorted, counted and a subset of identified nymphs are tested for pathogens.",
                              protocolReferences = "Paull, S. 2022. TOS Protocol and Procedure: TCK – Tick and Tick-Borne Pathogen Sampling. NEON.DOC.014045. NEON (National Ecological Observatory Network). | Laboratory of Medical Zoology (LMZ). 2023. NEON Tick Pathogen Testing SOP, V4.01. University of Massachusetts, Amherst. | Beati, L. 2021. Tick Identification Instructions, USNTC Standard Operating Procedure (SOP). V3. Georgia Southern University, US National Tick Collection (USNTC).",
                              isAbsenceReported = "true", #Q: Should this be reported true at this level or only at the event visit level?
                              absentTaxa = NA,
                              isAbundanceReported = "true",
                              isAbundanceCapReported = "false",
                              abundanceCap = NA,
                              hasMaterialSamples = "true", #Q: Since we're not explicitly designating these as material samples, should this be false?
                              materialSampleTypes = "wholeOrganism",
                              hasVouchers = "true",
                              voucherInstitutions = "US National Tick Collection, Georgia Southern University",
                              isLeastSpecificTargetCategoryQuantityInclusive = "false",
                              dataGeneralizations = NA,
                              informationWithheld = NA, #TODO: double check this - I don't think any tick taxa are withheld but I'm not 100% certain
                              fieldNotes = NA,
                              eventRemarks = NA,
                              verbatimTargetScope = "ticks", # Recommended best practice is to populate scope terms every Event to which they apply.
                              targetTaxonomicScope = "?Ixodidae", #Q: Since we have pathogens in occurrences, I'm not sure how to designate those here - the ones tested don't have a mca - most are Bacteria but one is a piroplasm
                              excludedTaxonomicScope = NA,
                              isTaxonomicScopeFullyReported = "true",
                              taxonCompletenessReported = "reportedComplete", #Q: I'm not 100% sure I did these two correctly
                              taxonCompletenessProtocols = "Tick drag/flag methods are standardized to comprehensively detect all life stages of Ixodidae during the active season.", #Q: I'm not 100% sure I did these two correctly
                              hasNonTargetTaxa = "false",
                              areNonTargetTaxaFullyReported = NA,
                              nonTargetTaxa = NA,
                              identifiedBy = tapply(
                                tick.occurrence$tck_taxonomyProcessed$laboratoryName,
                                tick.occurrence$tck_taxonomyProcessed$plotID,
                                function(x) paste(sort(unique(x)), collapse = " | ") #Q: Some plots have had no ticks identified, so identifiedBy is NA - should this be changed to something more descriptive, like 'No ticks found'?
                              )[NEON_plot_metadata$plotID], #Q: I could change this to get the actual list of people who did the identifications, though this is not clean
                              targetLifeStageScope = "adult | nymph | larvae",
                              excludedLifeStageScope = "egg",
                              isLifeStageScopeFullyReported = "true",
                              targetDegreeOfEstablishmentScope = NA,
                              excludedDegreeOfEstablishmentScope = NA,
                              isDegreeOfEstablishmentScopeFullyReported = NA,
                              targetGrowthFormScope = NA,
                              excludedGrowthFormScope = NA,
                              isGrowthFormScopeFullyReported = NA,
                              hasNonTargetOrganisms = NA,
                              targetHabitatScope = NA,
                              excludedHabitatScope = NA,
                              samplingEffort = "160 m perimeter sampled per bout",
                              isSamplingEffortReported = "true",
                              samplingEffortProtocol = "Ticks are sampled at six plots per site, with bouts every 3 or 6 weeks depending on intensity. Each bout consists of dragging (or flagging if needed) along the full 160 m perimeter of each 40 × 40 m plot. Ticks of all life stages are collected at intervals and preserved in ethanol.",
                              samplingEffortValue = "6, 160",
                              samplingEffortUnit = "plots per bout, meters per plot circuit",
                              samplingPerformedBy = "NEON Field Staff" #Q: I could change this to get the list of actual people, though this has orcid and emails and is quite messy
                            )

```

### Plot Visit Events

Plot visit events describe the actual sampling bouts, usually every three to six weeks during green-up. At this level, we record specific sampling dates, methods, conditions, and any remarks made during fieldwork. Presence–absence of ticks is also recorded here: if no ticks are collected during a visit, the absence is captured at the event level. These events provide the link between the hierarchical survey design and the occurrence records derived from individual tick or pathogen samples.

Q: I didn't map sampleCondition since we originally had this going to materialEntityRemarks. Since we're not doing materialSample, is this where it should still go?

```{r}
NEON_plot_visit_metadata <- tick.occurrence$tck_fielddata

added_plot_visit_data <- data.frame(parentEventID = NEON_plot_visit_metadata$plotID,
                                    eventID = ifelse(is.na(NEON_plot_visit_metadata$sampleID), #eventID is the sampleID if a sample is taken, if not, we create one with the same format (plotID.date)
                                                      paste0(
                                                        NEON_plot_visit_metadata$plotID, ".",
                                                        format(as.Date(NEON_plot_visit_metadata$collectDate), "%Y%m%d")
                                                      ),
                                                      NEON_plot_visit_metadata$sampleID
                                                    ),
                                    siteNestingDescription = "One visit to a 40x40 m plot designated for tick sampling",
                                    siteCount = 1, #Q: I don't know if this should be here for this event
                                    fieldNumber = NA,
                                    verbatimSiteNames = NEON_plot_visit_metadata$plotID,
                                    habitat = NEON_plot_visit_metadata$nlcdClass,
                                    verbatimSiteDescriptions = NA,
                                    reportedWeather = NA,
                                    reportedExtremeConditions = ifelse(
                                      is.na(NEON_plot_visit_metadata$samplingImpractical) | NEON_plot_visit_metadata$samplingImpractical == "OK", NA,
                                      paste0(NEON_plot_visit_metadata$samplingImpractical, ", sampling impractical")
                                    ),
                                    locationID = NEON_plot_visit_metadata$namedLocation,
                                    countryCode = "US",
                                    decimalLatitude = NEON_plot_visit_metadata$decimalLatitude,
                                    decimalLongitude = NEON_plot_visit_metadata$decimalLongitude,
                                    coordinateUncertaintyInMeters = NEON_plot_visit_metadata$coordinateUncertainty,
                                    geodeticDatum = "WGS84",
                                    locality = NEON_plot_visit_metadata$plotID,
                                    minimumElevationinMeters = NEON_plot_visit_metadata$elevation - NEON_plot_visit_metadata$elevationUncertainty,
                                    maximumElevationinMeters = NEON_plot_visit_metadata$elevation + NEON_plot_visit_metadata$elevationUncertainty,
                                    verbatimElevation = paste(NEON_plot_visit_metadata$elevation, "m", sep=""),
                                    totalAreaSampledValue = NEON_plot_visit_metadata$totalSampledArea,
                                    totalAreaSampledUnit = ifelse(
                                      is.na(NEON_plot_visit_metadata$totalSampledArea), NA, "m"
                                    ),
                                    geospatialScopeAreaValue = NA,
                                    geospatialScopeAreaUnit = NA,
                                    sampleSizeValue = NA,
                                    sampleSizeUnit = NA,
                                    footprintWKT = NA,
                                    footprintSRS = NA,
                                    isVegetationCoverReported = "false",
                                    eventDate = paste(NEON_plot_visit_metadata$collectDate),
                                    eventTime = NA,
                                    eventDurationValue = NA,
                                    eventDurationUnit = NA,
                                    eventType = "plot visit", #Q: This was 'Site Visit' in the mapping sheet
                                    inventoryTypes = NA,
                                    compilationTypes = NA,
                                    compilationSourceTypes = NA,
                                    samplingProtocol = NEON_plot_visit_metadata$samplingMethod, #Sampling protocol terms should be populated for every Event regardless of hierarchical level Q: I took this to mean all the terms described in 5.5. Methodology or sampling protocol (from here up to eventRemarks), or is this just for the four protocol fields?
                                    protocolNames = NEON_plot_visit_metadata$samplingMethod,
                                    protocolDescriptions = "Ticks are sampled at six plots per site every three to six weeks, depending on prior detections. Sampling follows the 160 m perimeter of each 40 × 40 m plot, using drag cloths (or flagging in dense vegetation). Ticks from all life stages are collected every few meters and preserved in ethanol, with bouts scheduled between green-up and dormancy. Samples are sent to external labs where they are sorted, counted and a subset of identified nymphs are tested for pathogens.",
                                    protocolReferences = paste(NEON_plot_visit_metadata$samplingProtocolVersion, "Paull, S. 2022. TOS Protocol and Procedure: TCK – Tick and Tick-Borne Pathogen Sampling. NEON.DOC.014045. NEON (National Ecological Observatory Network). | Laboratory of Medical Zoology (LMZ). 2023. NEON Tick Pathogen Testing SOP, V4.01. University of Massachusetts, Amherst. | Beati, L. 2021. Tick Identification Instructions, USNTC Standard Operating Procedure (SOP). V3. Georgia Southern University, US National Tick Collection (USNTC).", sep=" | "),
                                    isAbsenceReported = ifelse(
                                      is.na(NEON_plot_visit_metadata$targetTaxaPresent),
                                      "false",
                                      "true"
                                    ), #Q: I only did this at the event level, not the occurrence level (i.e., there are no occurrences with occurrenceStatus = absent) - the guide says otherwise #Q: if targetTaxaPresent is NA (ie. there was no sampling done, should this be NA or false?) #Q: I think I'm getting lost on if this is an attribute of the survey event visit or the protocol
                                    absentTaxa = ifelse(
                                      NEON_plot_visit_metadata$targetTaxaPresent == "N", "?Ixodidae", NA #Q: Since we have pathogens in occurrences, I'm not sure how to designate those here - the ones tested don't have a mca - most are Bacteria but one is a piroplasm  #Q: If there are no absences (i.e., there were ticks found) should this be something besides NA? Should this be a list of species?
                                    ),
                                    isAbundanceReported = ifelse(
                                      is.na(NEON_plot_visit_metadata$targetTaxaPresent),
                                      "false",
                                      "true"
                                    ), #Q: I think I'm getting lost on if this is an attribute of the survey event visit or the protocol #Q: If no survey occurred should this be something besides NA?
                                    isAbundanceCapReported = "false",
                                    abundanceCap = NA,
                                    hasMaterialSamples = "true", #Q: Since we're not explicitly designating these as material samples, should this be false?
                                    materialSampleTypes = "wholeOrganism",
                                    hasVouchers = "true",
                                    voucherInstitutions = "US National Tick Collection, Georgia Southern University",
                                    isLeastSpecificTargetCategoryQuantityInclusive = "false",
                                    dataGeneralizations = NA,
                                    informationWithheld = NA, #TODO: double check this - I don't think any tick taxa are withheld but I'm not 100% certain
                                    fieldNotes = NA,
                                    eventRemarks = NEON_plot_visit_metadata$remarks,
                                    verbatimTargetScope = "ticks", # Recommended best practice is to populate scope terms every Event to which they apply.
                                    targetTaxonomicScope = "?Ixodidae", #Q: Since we have pathogens in occurrences, I'm not sure how to designate those here - the ones tested don't have a mca - most are Bacteria but one is a piroplasm
                                    excludedTaxonomicScope = NA,
                                    isTaxonomicScopeFullyReported = "true",
                                    taxonCompletenessReported = "reportedComplete", #Q: I'm not 100% sure I did these two correctly
                                    taxonCompletenessProtocols = "Tick drag/flag methods are standardized to comprehensively detect all life stages of Ixodidae during the active season.", #Q: I'm not 100% sure I did these two correctly
                                    hasNonTargetTaxa = "false",
                                    areNonTargetTaxaFullyReported = NA,
                                    nonTargetTaxa = NA,
                                    identifiedBy = tick.occurrence$tck_fielddata %>% #Q: Some plots have had no ticks identified, so identifiedBy is NA - should this be changed to something more descriptive, like 'No ticks found'?
                                      left_join(
                                        tick.occurrence$tck_taxonomyProcessed %>%
                                          group_by(sampleID) %>%
                                          summarise(
                                            identifiedBy = paste(sort(unique(identifiedBy)), collapse = " | "),
                                            .groups = "drop"
                                          ),
                                        by = "sampleID"
                                      ) %>%
                                      pull(identifiedBy),
                                    targetLifeStageScope = "adult | nymph | larvae",
                                    excludedLifeStageScope = "egg",
                                    isLifeStageScopeFullyReported = "true",
                                    targetDegreeOfEstablishmentScope = NA,
                                    excludedDegreeOfEstablishmentScope = NA,
                                    isDegreeOfEstablishmentScopeFullyReported = NA,
                                    targetGrowthFormScope = NA,
                                    excludedGrowthFormScope = NA,
                                    isGrowthFormScopeFullyReported = NA,
                                    hasNonTargetOrganisms = NA,
                                    targetHabitatScope = NA,
                                    excludedHabitatScope = NA,
                                    samplingEffort = "160 m perimeter sampled per bout",
                                    isSamplingEffortReported = "true",
                                    samplingEffortProtocol = "Ticks are sampled at six plots per site, with bouts every 3 or 6 weeks depending on intensity. Each bout consists of dragging (or flagging if needed) along the full 160 m perimeter of each 40 × 40 m plot. Ticks of all life stages are collected at intervals and preserved in ethanol.",
                                    samplingEffortValue = "6, 160",
                                    samplingEffortUnit = "plots per bout, meters per plot circuit",
                                    samplingPerformedBy = NEON_plot_visit_metadata$measuredBy
                                  )

```

### Merge Event Tables

```{r}
event_data <- bind_rows(
  NEON_project_event,
  added_domain_data,
  added_site_data,
  added_plot_data,
  added_plot_visit_data
)
rownames(event_data) <- NULL
```

## Map Occurrence Data

Occurrence data represent the biological entities observed or derived within events. In this example, two kinds of occurrences are included:  

- Tick specimens collected in the field are represented as preserved specimen records identified to species, life stage, and sex where possible. These records only report presences. Absences of ticks are instead recorded at the plot visit event level, where a complete lack of specimens indicates that no ticks were found during sampling.  
- Laboratory results from pathogen testing are represented as separate occurrence records derived from those specimens. These records include both positive detections and explicit absences, reflecting whether a pathogen was found in a tested tick.  

To preserve the link between the tested specimens and the pathogens detected (or not detected), pathogen occurrences are connected back to the corresponding tick occurrences using the Darwin Core Resource Relationship extension. All occurrence records are associated with their sampling context through the `eventID` field.

### Tick Occurrences

Tick occurrence records correspond to individual specimens collected in the field. Attributes such as scientific name, life stage, sex, preparation, and voucher institution are included where available. These records are treated as preserved specimens and are linked to vouchers curated in external collections. All ticks collected prior to 2024 were identified and archived at the U.S. National Tick Collection at Georgia Southern University and tested at the Laboratory of Medical Zoology (LMZ) at the University of Massachusetts Amherst. Currently, ticks are identified and tested at the Laboratory of Medical Zoology (LMZ) at the University of Massachusetts Amherst and archived at the NEON Biorepository at Arizona State University.

```{r}
NEON_tick_occurrence_data <- tick.occurrence$tck_taxonomyProcessed

added_tick_occurrence_data <- data.frame(eventID = NEON_tick_occurrence_data$sampleID,
                                         occurrenceID = NEON_tick_occurrence_data$subsampleID,
                                         basisOfRecord = "PreservedSpecimen",
                                         scientificName = NEON_tick_occurrence_data$scientificName,
                                         scientificNameAuthorship = NEON_tick_occurrence_data$scientificNameAuthorship,
                                         taxonRank = NEON_tick_occurrence_data$taxonRank,
                                         kingdom = "Animalia",
                                         family = NEON_tick_occurrence_data$family,
                                         subfamily = NEON_tick_occurrence_data$subfamily,
                                         tribe = NEON_tick_occurrence_data$tribe,
                                         subtribe = NEON_tick_occurrence_data$subtribe,
                                         genus = NEON_tick_occurrence_data$genus,
                                         subgenus = NEON_tick_occurrence_data$subgenus,
                                         specificEpithet = NEON_tick_occurrence_data$specificEpithet,
                                         infraspecificEpithet = NEON_tick_occurrence_data$infraspecificEpithet,
                                         identificationQualifier = NEON_tick_occurrence_data$identificationQualifier,
                                         identificationReferences = NEON_tick_occurrence_data$identificationReferences,
                                         identificationRemarks = NEON_tick_occurrence_data$identificationProtocolVersion,
                                         occurrenceStatus = "present",
                                         organismQuantity = NA, #individualCount is used instead
                                         organismQuantityType = NA, #individualCount is used instead
                                         individualCount = NEON_tick_occurrence_data$individualCount,
                                         recordedByID = NA, #This information is in the plot visit event
                                         vernacularName = c("Dermacentor variabilis" = "American dog tick",
                                                            "Ixodes scapularis" = "Blacklegged tick / Deer tick",
                                                            "Haemaphysalis leporispalustris" = "Rabbit tick",
                                                            "Amblyomma americanum" = "Lone star tick",
                                                            "Haemaphysalis longicornis" = "Asian longhorned tick",
                                                            "Ixodes muris" = "Mouse tick",
                                                            "Ixodes dentatus" = "Rabbit tick",
                                                            "Amblyomma maculatum" = "Gulf Coast tick",
                                                            "Ixodes marxi" = "Squirrel tick",
                                                            "Ixodes brunneus" = "Bird tick",
                                                            "Dermacentor andersoni" = "Rocky Mountain wood tick",
                                                            "Dermacentor parumapertus" = "Desert wood tick",
                                                            "Ixodes pacificus" = "Western blacklegged tick",
                                                            "Ixodes angustus" = "Mouse tick",
                                                            "Dermacentor occidentalis" = "Pacific Coast tick"
                                                          )[NEON_tick_occurrence_data$scientificName],
                                         sex = ifelse(NEON_tick_occurrence_data$sexOrAge %in% c("Male", "Female"),
                                                       NEON_tick_occurrence_data$sexOrAge,
                                                       NA),
                                         lifeStage = ifelse(NEON_tick_occurrence_data$sexOrAge %in% c("Male", "Female"),
                                                             "Adult",
                                                             NEON_tick_occurrence_data$sexOrAge),
                                         establishmentMeans = NA,
                                         degreeOfEstablishment = NA,
                                         pathway = NA,
                                         vitality = "alive",
                                         preparations = NEON_tick_occurrence_data$archiveMedium,
                                         institutionID = NEON_tick_occurrence_data$archiveFacilityID,
                                         identifiedBy = paste(NEON_tick_occurrence_data$identifiedBy, NEON_tick_occurrence_data$laboratoryName, sep=", "),
                                         occurrenceRemarks = NEON_tick_occurrence_data$remarks
                               )

```

### Tick Pathogen Occurrences

A subset of collected ticks are subsequently tested for pathogens. The results of these tests are represented as separate occurrence records with the basisOfRecord `LaboratoryObservation`. Each record includes details of the test method, result, and pathogen name, and is linked back to the originating tick specimen through the Darwin Core Resource Relationship extension.

```{r}
NEON_pathogen_occurrence_data <- tick.pathogen$tck_pathogen %>%
  filter(
    !is.na(testResult) &
    !is.na(testPathogenName) &
      testPathogenName != "HardTick DNA Quality" & #Remove DNA Quality test
      !grepl("^(Ixodes|Dermacentor|Amblyomma|Haemaphysalis)", testPathogenName) #Remove molecular identification tests
  )

added_pathogen_occurrence_data <- data.frame(eventID = sapply(strsplit(NEON_pathogen_occurrence_data$subsampleID, "\\."), 
                                                              function(x) paste(x[1:2], collapse = ".")),
                                             occurrenceID = NEON_pathogen_occurrence_data$uid,
                                             basisOfRecord = "LaboratoryObservation",  #Q: I'm not sure what to put here
                                             scientificName = NEON_pathogen_occurrence_data$testPathogenName,
                                             taxonRank = NA,
                                             kingdom = c("Borrelia burgdorferi" = "Bacteria",
                                                         "Borrelia miyamotoi" = "Bacteria",
                                                         "Anaplasma phagocytophilum" = "Bacteria",
                                                         "Rickettsia rickettsii" = "Bacteria",
                                                         "Ehrlichia chaffeensis" = "Bacteria",
                                                         "Borrelia lonestari" = "Bacteria",
                                                         "Babesia microti" = "Protista",
                                                         "Ehrlichia ewingii" = "Bacteria",
                                                         "Borrelia burgdorferi sensu lato" = "Bacteria",
                                                         "Ehrlichia muris-like" = "Bacteria",
                                                         "Borrelia mayonii" = "Bacteria",
                                                         "Francisella tularensis" = "Bacteria",
                                                         "Borrelia sp." = "Bacteria",
                                                         "Rickettsia parkeri" = "Bacteria",
                                                         "Rickettsia philipii" = "Bacteria"
                                                         )[NEON_pathogen_occurrence_data$testPathogenName],
                                             occurrenceStatus = ifelse(NEON_pathogen_occurrence_data$testResult == "Negative", "absent",
                                                                       ifelse(NEON_pathogen_occurrence_data$testResult == "Positive", "present", NA)
                                                                      ),
                                             organismQuantity = NA,
                                             organismQuantityType = NA,
                                             individualCount = NA, #Recommend not sharing this until we find out specifically what this is actually reporting. Note: this is always 1.
                                             recordedByID = NA, #This information is in the plot visit event
                                             vernacularName = c("Borrelia burgdorferi" = "Lyme disease agent",
                                                                "Borrelia miyamotoi" = "Borrelia miyamotoi disease (BMD) agent",
                                                                "Anaplasma phagocytophilum" = "Human granulocytic anaplasmosis (HGA) agent",
                                                                "Rickettsia rickettsii" = "Rocky Mountain spotted fever agent",
                                                                "Ehrlichia chaffeensis" = "Human monocytic ehrlichiosis agent",
                                                                "Borrelia lonestari" = "Southern tick-associated rash illness (STARI) agent",
                                                                "Babesia microti" = "Babesiosis parasite",
                                                                "Ehrlichia ewingii"  = "Human ehrlichiosis agent",
                                                                "Borrelia burgdorferi sensu lato" = "Lyme disease agent",
                                                                "Ehrlichia muris-like" = "Human ehrlichiosis agent",
                                                                "Borrelia mayonii" = "Lyme disease agent",
                                                                "Francisella tularensis" = "Tularemia agent",
                                                                "Borrelia sp." = "Lyme disease or relapsing fever agent",
                                                                "Rickettsia parkeri" = "Rickettsia parkeri rickettsiosis agent",
                                                                "Rickettsia philipii" = "Pacific coast tick fever agent"
                                                               )[NEON_pathogen_occurrence_data$testPathogenName],
                                             sex = NA,
                                             lifeStage = NA,
                                             establishmentMeans = NA,
                                             degreeOfEstablishment = NA,
                                             pathway = NA,
                                             vitality = NA,
                                             identificationRemarks = paste(NEON_pathogen_occurrence_data$testProtocolVersion,
                                                                            ifelse(is.na(NEON_pathogen_occurrence_data$remarks), "", 
                                                                                   paste("; ", NEON_pathogen_occurrence_data$remarks))
                                                                          ),
                                             identifiedBy = paste(NEON_pathogen_occurrence_data$testedBy, NEON_pathogen_occurrence_data$laboratoryName, sep=", "),
                                             dateIdentified = NEON_pathogen_occurrence_data$testedDate,
                                             materialSampleID = NEON_pathogen_occurrence_data$testingID, #Q: Does this need to be remapped or removed since we aren't doing materialSample?
                                             materialEntityRemarks = "materialSampleID corresponds to the NEON testingID, which uniquely identifies the individual tick nymph(s) tested."
                                   )
```

### Merge Occurrence Tables
```{r}
occurrence_data <- bind_rows(added_tick_occurrence_data,
                             added_pathogen_occurrence_data)
rownames(occurrence_data) <- NULL
```


## Map Resource Relationship Data

Resource relationships describe links between different occurrences. In this dataset, pathogen detections are linked to the ticks from which they were derived using `relationshipOfResource = "pathogen of"`.

```{r}
resource_relationship_data <- data.frame(resourceID = NEON_pathogen_occurrence_data$uid, #occurrenceID (pathogen)
                                         relatedResourceID = NEON_pathogen_occurrence_data$subsampleID, #occurrenceID (tick)
                                         relationshipOfResource = "pathogen of"
)
```

## Map Extended Measurement or Fact Data

Certain details do not fit into the core event or occurrence tables. These are represented in the ExtendedMeasurementOrFact (eMoF) table. Examples include plot type, tick counts by life stage, sample barcodes, DNA identifiers, and sample conditions.

### Plot Type

```{r}
emof_plot_data <- data.frame(eventID = NEON_plot_metadata$plotID,
                             occurrenceID = NA, # This is just for readability of the final table
                             measurementType = "Plot Type",
                             measurementValue = NEON_plot_metadata$plotType
)
```

### Counts

```{r}
#Q: I removed records where these are NA, should I keep those in (i.e., and have a record for each event regardless)?
emof_counts_adult_data <- data.frame( #only create a row if adultCount is not NA
  eventID = ifelse( 
    is.na(NEON_plot_visit_metadata$sampleID), #eventID is the sampleID if a sample is taken, if not, we create one with the same format (plotID.date)
    paste0(NEON_plot_visit_metadata$plotID, ".",
           format(as.Date(NEON_plot_visit_metadata$collectDate), "%Y%m%d")
    ),
    NEON_plot_visit_metadata$sampleID
  )[!is.na(NEON_plot_visit_metadata$adultCount)],
  occurrenceID = NA, # This is just for readability of the final table
  measurementType = "Adult Count",
  measurementValue = as.character(NEON_plot_visit_metadata$adultCount[!is.na(NEON_plot_visit_metadata$adultCount)])
)

emof_counts_nymph_data <- data.frame( #only create a row if nymphCount is not NA
  eventID = ifelse( 
    is.na(NEON_plot_visit_metadata$sampleID), #eventID is the sampleID if a sample is taken, if not, we create one with the same format (plotID.date)
    paste0(NEON_plot_visit_metadata$plotID, ".",
           format(as.Date(NEON_plot_visit_metadata$collectDate), "%Y%m%d")
    ),
    NEON_plot_visit_metadata$sampleID
  )[!is.na(NEON_plot_visit_metadata$nymphCount)],
  occurrenceID = NA, # This is just for readability of the final table
  measurementType = "Nymph Count",
  measurementValue = as.character(NEON_plot_visit_metadata$nymphCount[!is.na(NEON_plot_visit_metadata$nymphCount)])
)

emof_counts_larva_data <- data.frame( #only create a row if larvaCount is not NA
  eventID = ifelse( 
    is.na(NEON_plot_visit_metadata$sampleID), #eventID is the sampleID if a sample is taken, if not, we create one with the same format (plotID.date)
    paste0(NEON_plot_visit_metadata$plotID, ".",
           format(as.Date(NEON_plot_visit_metadata$collectDate), "%Y%m%d")
    ),
    NEON_plot_visit_metadata$sampleID
  )[!is.na(NEON_plot_visit_metadata$larvaCount)],
  occurrenceID = NA, # This is just for readability of the final table
  measurementType = "Larva Count",
  measurementValue = as.character(NEON_plot_visit_metadata$larvaCount[!is.na(NEON_plot_visit_metadata$larvaCount)])
)
```

### Sample Code (Barcode)

```{r}
emof_sample_code_data <- data.frame( #only create a row if sampleCount is not NA
  eventID = ifelse(
    is.na(NEON_plot_visit_metadata$sampleID), #eventID is the sampleID if a sample is taken, if not, we create one with the same format (plotID.date)
    paste0(NEON_plot_visit_metadata$plotID, ".",
           format(as.Date(NEON_plot_visit_metadata$collectDate), "%Y%m%d")
    ),
    NEON_plot_visit_metadata$sampleID
  )[!is.na(NEON_plot_visit_metadata$sampleCode)],
  occurrenceID = NA, # This is just for readability of the final table
  measurementType = "Sample Barcode",
  measurementValue = NEON_plot_visit_metadata$sampleCode[!is.na(NEON_plot_visit_metadata$sampleCode)]
)
```

### Tick Sample Condition

```{r}
emof_tick_sample_condition_data <- data.frame(eventID = NEON_tick_occurrence_data$sampleID,
                                              occurrenceID = NEON_tick_occurrence_data$subsampleID,
                                              measurementType = "Tick Sample Condition",
                                              measurementValue = NEON_tick_occurrence_data$sampleCondition
)
```

### Deprecated Vial ID

```{r}
emof_deprecatedVialID_data <- data.frame(eventID = NEON_tick_occurrence_data$sampleID,
                                         occurrenceID = NEON_tick_occurrence_data$subsampleID,
                                         measurementType = "Deprecated Vial ID",
                                         measurementValue = NEON_tick_occurrence_data$deprecatedVialID
)
```

### Tick Pathogen Sample Condition

```{r}
emof_pathogen_sample_condition_data <- data.frame(eventID = sapply(strsplit(NEON_pathogen_occurrence_data$subsampleID, "\\."), 
                                                                   function(x) paste(x[1:2], collapse = ".")),
                                                  occurrenceID = NEON_pathogen_occurrence_data$uid,
                                                  measurementType = "Tick Pathogen Sample Condition",
                                                  measurementValue = NEON_pathogen_occurrence_data$sampleCondition
)
```

### CQ (Quantification Cycle or Threshold Number) Value

```{r}
emof_cqValue_data <- data.frame(
  eventID = sapply(strsplit(NEON_pathogen_occurrence_data$subsampleID[!is.na(NEON_pathogen_occurrence_data$cqValue)], "\\."),
                   function(x) paste(x[1:2], collapse = ".")),
  occurrenceID = NEON_pathogen_occurrence_data$uid[!is.na(NEON_pathogen_occurrence_data$cqValue)],
  measurementType = "CQ (Quantification Cycle or Threshold Number) Value",
  measurementValue = as.character(NEON_pathogen_occurrence_data$cqValue[!is.na(NEON_pathogen_occurrence_data$cqValue)])
)
```

### DNA Sample ID

```{r}
emof_dnaSampleID_data <- data.frame(
  eventID = sapply(strsplit(NEON_pathogen_occurrence_data$subsampleID[!is.na(NEON_pathogen_occurrence_data$dnaSampleID)], "\\."),
                   function(x) paste(x[1:2], collapse = ".")),
  occurrenceID = NEON_pathogen_occurrence_data$uid[!is.na(NEON_pathogen_occurrence_data$dnaSampleID)],
  measurementType = "Identifier for DNA sample",
  measurementValue = NEON_pathogen_occurrence_data$dnaSampleID[!is.na(NEON_pathogen_occurrence_data$dnaSampleID)]
)
```

### DNA Sample Code

```{r}
emof_dnaSampleCode_data <- data.frame(
  eventID = sapply(strsplit(NEON_pathogen_occurrence_data$subsampleID[!is.na(NEON_pathogen_occurrence_data$dnaSampleCode)], "\\."),
                   function(x) paste(x[1:2], collapse = ".")),
  occurrenceID = NEON_pathogen_occurrence_data$uid[!is.na(NEON_pathogen_occurrence_data$dnaSampleCode)],
  measurementType = "Barcode of a DNA sample",
  measurementValue = NEON_pathogen_occurrence_data$dnaSampleCode[!is.na(NEON_pathogen_occurrence_data$dnaSampleCode)]
)
```

### Merge Extended Measurement or Fact Tables

```{r}
emof_data <- bind_rows(emof_plot_data,
                       emof_counts_adult_data,
                       emof_counts_nymph_data,
                       emof_counts_larva_data,
                       emof_sample_code_data,
                       emof_tick_sample_condition_data,
                       emof_deprecatedVialID_data,
                       emof_pathogen_sample_condition_data,
                       emof_cqValue_data,
                       emof_dnaSampleID_data,
                       emof_dnaSampleCode_data
                       )
rownames(emof_data) <- NULL
```

# Save Data

The processed event and occurrence tables generated through this workflow are available in the project repository. [NEONTickstoHumboldt/outputs](https://github.com/sunray1/NEONTickstoHumboldt/tree/master/outputs).

```{r}
write.csv(event_data, "outputs/event.csv", row.names = FALSE)
write.csv(occurrence_data, "outputs/occurrence.csv", row.names = FALSE)
write.csv(resource_relationship_data, "outputs/resourceRelationship.csv", row.names = FALSE)
write.csv(emof_data, "outputs/extendedMeasurementOrFact.csv", row.names = FALSE)
```
